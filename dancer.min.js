
function FourierTransform(a,b){this.bufferSize=a,this.sampleRate=b,this.bandwidth=2/a*b/2,this.spectrum=new Float32Array(a/2),this.real=new Float32Array(a),this.imag=new Float32Array(a),this.peakBand=0,this.peak=0,this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2},this.calculateSpectrum=function(){var b=this.spectrum,c=this.real,d=this.imag,e=2/this.bufferSize,f=Math.sqrt,g,h,i;for(var j=0,k=a/2;j<k;j++)g=c[j],h=d[j],i=e*f(g*g+h*h),i>this.peak&&(this.peakBand=j,this.peak=i),b[j]=i}}function FFT(a,b){FourierTransform.call(this,a,b),this.reverseTable=new Uint32Array(a);var c=1,d=a>>1,e;while(c<a){for(e=0;e<c;e++)this.reverseTable[e+c]=this.reverseTable[e]+d;c<<=1,d>>=1}this.sinTable=new Float32Array(a),this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}(function(){function b(){for(var a in this.sections)this.sections[a].condition()&&this.sections[a].callback.call(this)}var a=function(c){this.audioAdapter=window.webkitAudioContext?new a.adapters.webkit(this):new a.adapters.moz(this),this.events={},this.sections=[],this.bind("update",b),this.audioAdapter.load(c)};a.adapters={},a.prototype={play:function(){return this.audioAdapter.play(),this},stop:function(){return this.audioAdapter.stop(),this},createBeat:function(b,c,d,e,f){return new a.Beat(this,b,c,d,e,f)},bind:function(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b),this},unbind:function(a){return this.events[a]&&delete this.events[a],this},trigger:function(a){var b=this;return this.events[a]&&this.events[a].forEach(function(a){a.call(b)}),this},time:function(){return this.audioAdapter.getTime()},frequency:function(a,b){var c;return b!==undefined?(c=this.spectrum().slice(a,b+1),c.reduce(function(a,b){return a+b})/c.length):this.spectrum()[a]},spectrum:function(){return this.audioAdapter.getSpectrum()},isLoaded:function(){return this.audioAdapter.loaded},after:function(a,b){var c=this;return this.sections.push({condition:function(){return c.time()>a},callback:b}),this},before:function(a,b){var c=this;return this.sections.push({condition:function(){return c.time()<a},callback:b}),this},between:function(a,b,c){var d=this;return this.sections.push({condition:function(){return d.time()>a&&d.time()<b},callback:c}),this},onceAt:function(a,b){var c=this,d=null;return this.sections.push({condition:function(){return c.time()>a&&!this.called},callback:function(){b.call(this),d.called=!0},called:!1}),d=this.sections[this.sections.length-1],this}},a.addPlugin=function(b,c){a.prototype[b]===undefined&&(a.prototype[b]=c)},window.Dancer=a})(),function(){var a=function(a,b,c,d,e,f){this.dancer=a,this.frequency=b,this.threshold=c,this.decay=d,this.onBeat=e,this.offBeat=f,this.isOn=!1,this.currentThreshold=c;var g=this;this.dancer.bind("update",function(){if(!g.isOn)return;var a=g.dancer.spectrum()[g.frequency];a>=g.currentThreshold&&a>=g.threshold?(g.currentThreshold=a,e.call(g.dancer,a)):(f.call(g.dancer,a),g.currentThreshold-=g.decay)})};a.prototype={on:function(){this.isOn=!0},off:function(){this.isOn=!1}},window.Dancer.Beat=a}(),FFT.prototype.forward=function(a){var b=this.bufferSize,c=this.cosTable,d=this.sinTable,e=this.reverseTable,f=this.real,g=this.imag,h=this.spectrum,i=Math.floor(Math.log(b)/Math.LN2);if(Math.pow(2,i)!==b)throw"Invalid buffer size, must be a power of 2.";if(b!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+b+" Buffer Size: "+a.length;var j=1,k,l,m,n,o,p,q,r,s;for(s=0;s<b;s++)f[s]=a[e[s]],g[s]=0;while(j<b){k=c[j],l=d[j],m=1,n=0;for(var t=0;t<j;t++){s=t;while(s<b)o=s+j,p=m*f[o]-n*g[o],q=m*g[o]+n*f[o],f[o]=f[s]-p,g[o]=g[s]-q,f[s]+=p,g[s]+=q,s+=j<<1;r=m,m=r*k-n*l,n=r*l+n*k}j<<=1}return this.calculateSpectrum()},function(){SAMPLE_SIZE=2048;var a=function(a){this.dancer=a,this.context=window.audioContext?new window.AudioContext:new window.webkitAudioContext};a.prototype={load:function(a,b){var c=new XMLHttpRequest,d=this;this.source=this.context.createBufferSource(),this.loaded=!1,c.open("GET",a,!0),c.responseType="arraybuffer",c.onload=function(){d.context.decodeAudioData?d.context.decodeAudioData(c.response,function(a){d.source.buffer=a},function(a){console.log(a)}):d.source.buffer=d.context.createBuffer(c.response,!1),d.source.connect(d.context.destination),d.source.connect(d.fft),d.fft.connect(d.proc),d.proc.connect(d.context.destination),d.loaded=!0,d.dancer.trigger("loaded")},c.send(),this.proc=this.context.createJavaScriptNode(SAMPLE_SIZE/2,1,1),this.proc.onaudioprocess=function(){d.update.call(d)},this.source.connect(this.context.destination),this.fft=this.context.createAnalyser(),this.data=new Uint8Array(this.fft.frequencyBinCount)},play:function(){var a=this;(function b(){setTimeout(function(){a.loaded?a.source.noteOn(0):b()},10)})()},stop:function(){this.source.noteOff(0)},getSpectrum:function(){return this.data},getTime:function(){return this.context.currentTime},update:function(a){this.fft.getByteFrequencyData(this.data),this.dancer.trigger("update")}},Dancer.adapters.webkit=a}(),function(){var a=function(a){this.dancer=a,this.audio=new Audio,this.loaded=!1};a.prototype={load:function(a){var b=this;this.audio.src=a,this.audio.addEventListener("loadedmetadata",function(a){b.fbLength=b.audio.mozFrameBufferLength,b.channels=b.audio.mozChannels,b.rate=b.audio.mozSampleRate,b.fft=new FFT(b.fbLength/b.channels,b.rate),b.signal=new Float32Array(b.fbLength/b.channels),b.loaded=!0,b.tempFloat=Float32Array(b.fbLength/b.channels),b.dancer.trigger("loaded")},!1),this.audio.addEventListener("MozAudioAvailable",function(a){b.update(a)},!1)},play:function(){this.audio.play()},stop:function(){this.audio.pause()},getSpectrum:function(){for(var a=0,b=this.tempFloat.length;a<b;a++)this.tempFloat[a]=this.fft.spectrum[a]*2048;return this.tempFloat},getTime:function(){return this.time},update:function(a){if(!this.loaded)return;for(var b=0,c=this.fbLength/2;b<c;b++)this.signal[b]=(a.frameBuffer[2*b]+a.frameBuffer[2*b+1])/2;this.time=a.time,this.fft.forward(this.signal),this.dancer.trigger("update")}},Dancer.adapters.moz=a}()